(()=>{"use strict";var e={450:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.isValidIdentity=void 0,t.isValidIdentity=function(e){return"object"==typeof e&&null!==e&&"advertising_token"in e&&"identity_expires"in e&&"refresh_from"in e&&"refresh_token"in e&&"refresh_expires"in e}},47:(e,t)=>{var i;Object.defineProperty(t,"__esModule",{value:!0}),t.notifyInitCallback=t.IdentityStatus=void 0,(i=t.IdentityStatus||(t.IdentityStatus={}))[i.ESTABLISHED=0]="ESTABLISHED",i[i.REFRESHED=1]="REFRESHED",i[i.EXPIRED=100]="EXPIRED",i[i.NO_IDENTITY=-1]="NO_IDENTITY",i[i.INVALID=-2]="INVALID",i[i.REFRESH_EXPIRED=-3]="REFRESH_EXPIRED",i[i.OPTOUT=-4]="OPTOUT",t.notifyInitCallback=function(e,t,i,n){if(e.callback){const s={advertisingToken:n,advertising_token:n,status:t,statusText:i};try{e.callback(s)}catch(e){console.warn("UID2 init callback threw an exception",e)}}}},698:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.isUID2OptionsOrThrow=void 0,t.isUID2OptionsOrThrow=function(e){if("object"!=typeof e||null===e)throw new TypeError("opts must be an object");const t=e;if(void 0!==t.callback&&"function"!=typeof t.callback)throw new TypeError("opts.callback, if provided, must be a function");if(void 0!==t.refreshRetryPeriod){if("number"!=typeof t.refreshRetryPeriod)throw new TypeError("opts.refreshRetryPeriod must be a number");if(t.refreshRetryPeriod<1e3)throw new RangeError("opts.refreshRetryPeriod must be >= 1000")}return!0}},720:function(e,t,i){var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,r){function o(e){try{l(n.next(e))}catch(e){r(e)}}function a(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}l((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Uid2ApiClient=void 0;const s=i(890),r=i(450),o=i(693),a=i(734),l=i(494),d=i(111);t.Uid2ApiClient=class{constructor(e){var t;this._requestsInFlight=[],this._baseUrl=null!==(t=e.baseUrl)&&void 0!==t?t:"https://prod.uidapi.com",this._clientVersion="uid2-sdk-"+s.UID2.VERSION}hasActiveRequests(){return this._requestsInFlight.length>0}ResponseToRefreshResult(e){return function(e){return!!function(e){return"object"==typeof e&&null!==e&&"status"in e}(e)&&("optout"===e.status||"expired_token"===e.status||"success"===e.status&&"body"in e&&(0,r.isValidIdentity)(e.body))}(e)?"success"===e.status?{status:e.status,identity:e.body}:e:"Response didn't contain a valid status"}abortActiveRequests(){this._requestsInFlight.forEach((e=>{e.abort()})),this._requestsInFlight=[]}callRefreshApi(e){const t=this._baseUrl+"/v2/token/refresh",i=new XMLHttpRequest;let n,s;this._requestsInFlight.push(i),i.overrideMimeType("text/plain"),i.open("POST",t,!0),i.setRequestHeader("X-UID2-Client-Version",this._clientVersion);const r=new Promise(((e,t)=>{n=e,s=t}));return i.onreadystatechange=()=>{if(i.readyState===i.DONE){this._requestsInFlight=this._requestsInFlight.filter((e=>e!==i));try{if(e.refresh_response_key&&200===i.status){const t=(0,d.base64ToBytes)(i.responseText);window.crypto.subtle.importKey("raw",(0,d.base64ToBytes)(e.refresh_response_key),{name:"AES-GCM"},!1,["decrypt"]).then((e=>{window.crypto.subtle.decrypt({name:"AES-GCM",iv:t.slice(0,12),tagLength:128},e,t.slice(12)).then((e=>{const t=String.fromCharCode(...new Uint8Array(e)),i=JSON.parse(t),r=this.ResponseToRefreshResult(i);"string"==typeof r?s(r):n(r)}),(e=>console.warn("Call to UID2 API failed",e)))}),(e=>console.warn("Call to UID2 API failed",e)))}else{const e=JSON.parse(i.responseText),t=this.ResponseToRefreshResult(e);"string"==typeof t?s(t):n(t)}}catch(e){s(e)}}},i.send(e.refresh_token),r}callCstgApi(e,t){return n(this,void 0,void 0,(function*(){const i="emailHash"in e?{email_hash:e.emailHash}:{phone_hash:e.phoneHash},s=yield o.UID2CstgBox.build((0,l.stripPublicKeyPrefix)(t.serverPublicKey)),c=new TextEncoder,u=Date.now(),{iv:h,ciphertext:p}=yield s.encrypt(c.encode(JSON.stringify(i)),c.encode(JSON.stringify([u]))),y=yield(0,a.exportPublicKey)(s.clientPublicKey),f={payload:(0,d.bytesToBase64)(new Uint8Array(p)),iv:(0,d.bytesToBase64)(new Uint8Array(h)),public_key:(0,d.bytesToBase64)(new Uint8Array(y)),timestamp:u,subscription_id:t.subscriptionId},_=this._baseUrl+"/v2/token/client-generate",v=new XMLHttpRequest;let g,I;this._requestsInFlight.push(v),v.overrideMimeType("text/plain"),v.open("POST",_,!0);const b=new Promise(((e,t)=>{g=e,I=t}));return v.onreadystatechange=()=>n(this,void 0,void 0,(function*(){if(v.readyState===v.DONE){this._requestsInFlight=this._requestsInFlight.filter((e=>e!==v));try{if(200===v.status){const e=(0,d.base64ToBytes)(v.responseText),t=yield s.decrypt(e.slice(0,12),e.slice(12)),i=(new TextDecoder).decode(t),n=JSON.parse(i);!function(e){if(null===e||"object"!=typeof e)return!1;const t=e;return"success"===t.status&&(0,r.isValidIdentity)(t.body)}(n)?I(`API error: Response body was invalid for HTTP status 200: ${i}`):g({status:"success",identity:n.body})}else if(400===v.status){const e=JSON.parse(v.responseText);!function(e){if(null===e||"object"!=typeof e)return!1;const t=e;return"client_error"===t.status&&"string"==typeof t.message}(e)?I(`API error: Response body was invalid for HTTP status 400: ${v.responseText}`):I(`Client error: ${e.message}`)}else if(403===v.status){const e=JSON.parse(v.responseText);!function(e){if(null===e||"object"!=typeof e)return!1;const t=e;return"invalid_http_origin"===t.status&&"string"==typeof t.message}(e)?I(`API error: Response body was invalid for HTTP status 403: ${v.responseText}`):I(`Forbidden: ${e.message}`)}else I(`API error: Unexpected HTTP status ${v.status}`)}catch(e){I(e)}}})),v.send(JSON.stringify(f)),yield b}))}}},111:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.bytesToBase64=t.base64ToBytes=void 0,t.base64ToBytes=function(e){const t=atob(e);return Uint8Array.from(t,(e=>e.codePointAt(0)))},t.bytesToBase64=function(e){const t=Array.from(e,(e=>String.fromCodePoint(e))).join("");return btoa(t)}},443:(e,t)=>{var i;Object.defineProperty(t,"__esModule",{value:!0}),t.Uid2CallbackManager=t.EventType=void 0,function(e){e.InitCompleted="InitCompleted",e.IdentityUpdated="IdentityUpdated",e.SdkLoaded="SdkLoaded"}(i=t.EventType||(t.EventType={}));class n{constructor(e,t){this._sentInit=!1,this._getIdentity=t,this._uid2=e,this._uid2.callbacks.push=this.callbackPushInterceptor.bind(this)}callbackPushInterceptor(...e){var t;for(const s of e)n._sentSdkLoaded&&this.safeRunCallback(s,i.SdkLoaded,{}),this._sentInit&&this.safeRunCallback(s,i.InitCompleted,{identity:null!==(t=this._getIdentity())&&void 0!==t?t:null});return Array.prototype.push.apply(this._uid2.callbacks,e)}runCallbacks(e,t){var s;if(e===i.InitCompleted&&(this._sentInit=!0),e===i.SdkLoaded&&(n._sentSdkLoaded=!0),!this._sentInit&&e!==i.SdkLoaded)return;const r=Object.assign(Object.assign({},t),{identity:null!==(s=this._getIdentity())&&void 0!==s?s:null});for(const t of this._uid2.callbacks)this.safeRunCallback(t,e,r)}safeRunCallback(e,t,i){if("function"==typeof e)try{e(t,i)}catch(e){console.warn("UID2 callback threw an exception",e)}else console.warn("A UID2 SDK callback was supplied which isn't a function.")}}t.Uid2CallbackManager=n,n._sentSdkLoaded=!1},494:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.isClientSideIdentityOptionsOrThrow=t.stripPublicKeyPrefix=void 0,t.stripPublicKeyPrefix=function(e){return e.substring(9)},t.isClientSideIdentityOptionsOrThrow=function(e){if("object"!=typeof e||null===e)throw new TypeError("opts must be an object");const t=e;if("string"!=typeof t.serverPublicKey)throw new TypeError("opts.serverPublicKey must be a string");const i=/^UID2-X-[A-Z]-.+/;if(!i.test(t.serverPublicKey))throw new TypeError(`opts.serverPublicKey must match the regular expression ${i}`);if("string"!=typeof t.subscriptionId)throw new TypeError("opts.subscriptionId must be a string");if(0===t.subscriptionId.length)throw new TypeError("opts.subscriptionId is empty");return!0}},834:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.UID2CookieManager=t.isLegacyCookie=void 0;const n=i(890),s=i(450);function r(e){if("object"!=typeof e||!e)return!1;const t=e;return!!("advertising_token"in t&&"refresh_token"in t&&t.advertising_token&&t.refresh_token)}t.isLegacyCookie=r,t.UID2CookieManager=class{constructor(e){this._cookieName=n.UID2.COOKIE_NAME,this._opts=e}setCookie(e){var t;const i=JSON.stringify(e),n=new Date(e.refresh_expires),s=null!==(t=this._opts.cookiePath)&&void 0!==t?t:"/";let r=this._cookieName+"="+encodeURIComponent(i)+" ;path="+s+";expires="+n.toUTCString();void 0!==this._opts.cookieDomain&&(r+=";domain="+this._opts.cookieDomain),document.cookie=r}removeCookie(){document.cookie=this._cookieName+"=;expires=Tue, 1 Jan 1980 23:59:59 GMT"}getCookie(){const e=document.cookie;if(e){const t=e.split("; ").find((e=>e.startsWith(this._cookieName+"=")));if(t)return decodeURIComponent(t.split("=")[1])}}migrateLegacyCookie(e,t){const i=function(e,t){return Object.assign({refresh_from:t,refresh_expires:t+6048e5,identity_expires:t+144e5},e)}(e,t);return this.setCookie(i),i}loadIdentityFromCookie(){const e=this.getCookie();if(e){const t=JSON.parse(e);if((0,s.isValidIdentity)(t))return t;if(r(t))return this.migrateLegacyCookie(t,Date.now())}return null}}},693:function(e,t,i){var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,r){function o(e){try{l(n.next(e))}catch(e){r(e)}}function a(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}l((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.UID2CstgBox=void 0;const s=i(734);class r{constructor(e,t){this._clientPublicKey=e,this._sharedKey=t}static build(e){return n(this,void 0,void 0,(function*(){const t=yield(0,s.generateKeyPair)(r._namedCurve),i=yield(0,s.importPublicKey)(e,this._namedCurve),n=yield(0,s.deriveKey)(i,t.privateKey);return new r(t.publicKey,n)}))}encrypt(e,t){return n(this,void 0,void 0,(function*(){const i=window.crypto.getRandomValues(new Uint8Array(12));return{iv:i,ciphertext:yield(0,s.encrypt)(e,this._sharedKey,i,t)}}))}decrypt(e,t){return n(this,void 0,void 0,(function*(){return yield(0,s.decrypt)(t,this._sharedKey,e)}))}get clientPublicKey(){return this._clientPublicKey}}t.UID2CstgBox=r,r._namedCurve="P-256"},734:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.decrypt=t.encrypt=t.deriveKey=t.exportPublicKey=t.importPublicKey=t.generateKeyPair=void 0;const n=i(111);t.generateKeyPair=function(e){const t={name:"ECDH",namedCurve:e};return window.crypto.subtle.generateKey(t,!1,["deriveKey"])},t.importPublicKey=function(e,t){const i={name:"ECDH",namedCurve:t};return window.crypto.subtle.importKey("spki",(0,n.base64ToBytes)(e),i,!1,[])},t.exportPublicKey=function(e){return window.crypto.subtle.exportKey("spki",e)},t.deriveKey=function(e,t){return window.crypto.subtle.deriveKey({name:"ECDH",public:e},t,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])},t.encrypt=function(e,t,i,n){return window.crypto.subtle.encrypt({name:"AES-GCM",iv:i,additionalData:n},t,e)},t.decrypt=function(e,t,i){return window.crypto.subtle.decrypt({name:"AES-GCM",iv:i},t,e)}},993:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.normalizeEmail=t.isNormalizedPhone=void 0,t.isNormalizedPhone=function(e){return/^\+[0-9]{10,15}$/.test(e)},t.normalizeEmail=function(e){if(!e||!e.length)return;const t=e.trim().toLowerCase();if(t.indexOf(" ")>0)return;const i=function(e){const t=e.split("@");if(t.length&&2===t.length&&!t.some((e=>""===e)))return{address:t[0],domain:t[1]}}(t);if(!i)return;const{address:n,domain:s}=i,r=function(e){return"gmail.com"===e}(s),o=function(e,t,i){let n=e;return t&&(n=n.replaceAll(".","")),i&&(n=function(e,t="+"){return e.split(t)[0]}(n)),n}(n,r,r);return o?`${o}@${s}`:void 0}},411:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.isBase64Hash=void 0,t.isBase64Hash=function(e){if(!e||44!==e.length)return!1;try{return btoa(atob(e))===e}catch(e){return!1}}},987:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.UID2LocalStorageManager=t.localStorageKeyName=void 0;const n=i(450);t.localStorageKeyName="UID2-sdk-identity",t.UID2LocalStorageManager=class{setValue(e){const i=JSON.stringify(e);localStorage.setItem(t.localStorageKeyName,i)}removeValue(){localStorage.removeItem(t.localStorageKeyName)}getValue(){return localStorage.getItem(t.localStorageKeyName)}loadIdentityFromLocalStorage(){const e=this.getValue();if(e){const t=JSON.parse(e);if((0,n.isValidIdentity)(t))return t}return null}}},641:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.UID2PromiseHandler=void 0;const n=i(443);t.UID2PromiseHandler=class{constructor(e){this._promises=[],this._seenInitOrRejectAll=!1,e.callbacks.push(this._handleEvent.bind(this))}_handleEvent(e,t){e!==n.EventType.InitCompleted&&e!==n.EventType.IdentityUpdated||(e===n.EventType.InitCompleted&&(this._seenInitOrRejectAll=!0),this._apiClient&&this._apiClient.hasActiveRequests()||(this._promises.forEach((e=>{"identity"in t&&t.identity?e.resolve(t.identity.advertising_token):e.reject(new Error("No identity available."))})),this._promises=[]))}rejectAllPromises(e){this._seenInitOrRejectAll=!0,this._promises.forEach((t=>{t.reject(e)})),this._promises=[]}createMaybeDeferredPromise(e){return!this._seenInitOrRejectAll||this._apiClient&&this._apiClient.hasActiveRequests()?new Promise(((e,t)=>{this._promises.push({resolve:e,reject:t})})):e?Promise.resolve(e):Promise.reject(new Error("Identity not available"))}registerApiClient(e){this._apiClient=e}}},890:function(e,t,i){var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,r){function o(e){try{l(n.next(e))}catch(e){r(e)}}function a(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}l((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.sdkWindow=t.__uid2InternalHandleScriptLoad=t.UID2=void 0;const s=i(147),r=i(47),o=i(698),a=i(720),l=i(111),d=i(443),c=i(494),u=i(993),h=i(411),p=i(641),y=i(348);function f(e,t=Date.now()){return e<=t}let _=null;class v{constructor(e){this.callbacks=[],this._opts={},this._initComplete=!1,this._refreshTimerId=null,e&&(this.callbacks=e),this._tokenPromiseHandler=new p.UID2PromiseHandler(this),this._callbackManager=new d.Uid2CallbackManager(this,(()=>this.getIdentity()));const t=()=>{this._callbackManager.runCallbacks(d.EventType.SdkLoaded,{})};window.__uid2 instanceof v?t():_=t}static get VERSION(){return s.version}static get COOKIE_NAME(){return"__uid_2"}static get DEFAULT_REFRESH_RETRY_PERIOD_MS(){return 5e3}static setupGoogleTag(){v.setupGoogleSecureSignals()}static setupGoogleSecureSignals(){window.__uid2SecureSignalProvider&&window.__uid2SecureSignalProvider.registerSecureSignalProvider()}init(e){this.initInternal(e)}getAdvertisingToken(){var e,t;return null!==(t=null===(e=this.getIdentity())||void 0===e?void 0:e.advertising_token)&&void 0!==t?t:void 0}setIdentityFromEmail(e,t){return n(this,void 0,void 0,(function*(){if(this.throwIfInitNotComplete("Cannot set identity before calling init."),(0,c.isClientSideIdentityOptionsOrThrow)(t),void 0===(0,u.normalizeEmail)(e))throw new Error("Invalid email address");const i=yield v.hash(e);yield this.callCstgAndSetIdentity({emailHash:i},t)}))}setIdentityFromEmailHash(e,t){return n(this,void 0,void 0,(function*(){if(this.throwIfInitNotComplete("Cannot set identity before calling init."),(0,c.isClientSideIdentityOptionsOrThrow)(t),!(0,h.isBase64Hash)(e))throw new Error("Invalid hash");yield this.callCstgAndSetIdentity({emailHash:e},t)}))}setIdentityFromPhone(e,t){return n(this,void 0,void 0,(function*(){if(this.throwIfInitNotComplete("Cannot set identity before calling init."),(0,c.isClientSideIdentityOptionsOrThrow)(t),!(0,u.isNormalizedPhone)(e))throw new Error("Invalid phone number");const i=yield v.hash(e);yield this.callCstgAndSetIdentity({phoneHash:i},t)}))}setIdentityFromPhoneHash(e,t){return n(this,void 0,void 0,(function*(){if(this.throwIfInitNotComplete("Cannot set identity before calling init."),(0,c.isClientSideIdentityOptionsOrThrow)(t),!(0,h.isBase64Hash)(e))throw new Error("Invalid hash");yield this.callCstgAndSetIdentity({phoneHash:e},t)}))}setIdentity(e){this._apiClient&&this._apiClient.abortActiveRequests();const t=this.validateAndSetIdentity(e);t&&(this.triggerRefreshOrSetTimer(t),this._callbackManager.runCallbacks(d.EventType.IdentityUpdated,{}))}getIdentity(){return this._identity&&!this.temporarilyUnavailable()?this._identity:null}getAdvertisingTokenAsync(){const e=this.getAdvertisingToken();return this._tokenPromiseHandler.createMaybeDeferredPromise(null!=e?e:null)}isLoginRequired(){var e;if(this._initComplete)return!(this.isLoggedIn()||(null===(e=this._apiClient)||void 0===e?void 0:e.hasActiveRequests()))}disconnect(){this.abort("UID2 SDK disconnected."),this._storageManager?this._storageManager.removeValues():new y.UID2StorageManager({}).removeValues(),this._identity=void 0,this._callbackManager.runCallbacks(v.EventType.IdentityUpdated,{identity:null})}abort(e){this._initComplete=!0,this._tokenPromiseHandler.rejectAllPromises(null!=e?e:new Error("UID2 SDK aborted.")),this._refreshTimerId&&(clearTimeout(this._refreshTimerId),this._refreshTimerId=null),this._apiClient&&this._apiClient.abortActiveRequests()}static hash(e){return n(this,void 0,void 0,(function*(){const t=yield window.crypto.subtle.digest("SHA-256",(new TextEncoder).encode(e));return(0,l.bytesToBase64)(new Uint8Array(t))}))}initInternal(e){var t;if(this._initComplete)throw new TypeError("Calling init() more than once is not allowed");if(!(0,o.isUID2OptionsOrThrow)(e))throw new TypeError("Options provided to UID2 init couldn't be validated.");let i;this._opts=e,this._storageManager=new y.UID2StorageManager(Object.assign({},e)),this._apiClient=new a.Uid2ApiClient(e),this._tokenPromiseHandler.registerApiClient(this._apiClient),i=this._opts.identity?this._opts.identity:this._storageManager.loadIdentityWithFallback();const n=this.validateAndSetIdentity(i);n&&this.triggerRefreshOrSetTimer(n),this._initComplete=!0,null===(t=this._callbackManager)||void 0===t||t.runCallbacks(d.EventType.InitCompleted,{})}isLoggedIn(){return this._identity&&!f(this._identity.refresh_expires)}temporarilyUnavailable(){var e;return!(this._identity||!(null===(e=this._apiClient)||void 0===e?void 0:e.hasActiveRequests()))||!(!this._identity||!f(this._identity.identity_expires)||f(this._identity.refresh_expires))}getIdentityStatus(e){return e?e.advertising_token?e.refresh_token?f(e.refresh_expires,Date.now())?{valid:!1,errorMessage:"Identity expired, refresh expired",status:r.IdentityStatus.REFRESH_EXPIRED,identity:null}:f(e.identity_expires,Date.now())?{valid:!0,errorMessage:"Identity expired, refresh still valid",status:r.IdentityStatus.EXPIRED,identity:e}:void 0===this._identity?{valid:!0,identity:e,status:r.IdentityStatus.ESTABLISHED,errorMessage:"Identity established"}:{valid:!0,identity:e,status:r.IdentityStatus.REFRESHED,errorMessage:"Identity refreshed"}:{valid:!1,errorMessage:"refresh_token is not available or is not valid",status:r.IdentityStatus.INVALID,identity:null}:{valid:!1,errorMessage:"advertising_token is not available or is not valid",status:r.IdentityStatus.INVALID,identity:null}:{valid:!1,errorMessage:"Identity not available",status:v.IdentityStatus.NO_IDENTITY,identity:null}}validateAndSetIdentity(e,t,i){var n,s;if(!this._storageManager)throw new Error("Cannot set identity before calling init.");const o=this.getIdentityStatus(e);return o.identity&&(null===(n=o.identity)||void 0===n?void 0:n.advertising_token)===(null===(s=this._identity)||void 0===s?void 0:s.advertising_token)||(this._identity=o.identity,o.identity?this._storageManager.setValue(o.identity):(this.abort(),this._storageManager.removeValues()),(0,r.notifyInitCallback)(this._opts,null!=t?t:o.status,null!=i?i:o.errorMessage,this.getAdvertisingToken())),o.identity}triggerRefreshOrSetTimer(e){f(e.refresh_from,Date.now())?this.refreshToken(e):this.setRefreshTimer()}setRefreshTimer(){var e,t;const i=null!==(t=null===(e=this._opts)||void 0===e?void 0:e.refreshRetryPeriod)&&void 0!==t?t:v.DEFAULT_REFRESH_RETRY_PERIOD_MS;this._refreshTimerId&&clearTimeout(this._refreshTimerId),this._refreshTimerId=setTimeout((()=>{var e,t;if(this.isLoginRequired())return;const i=this.validateAndSetIdentity(null!==(t=null===(e=this._storageManager)||void 0===e?void 0:e.loadIdentity())&&void 0!==t?t:null);i&&this.triggerRefreshOrSetTimer(i),this._refreshTimerId=null}),i)}refreshToken(e){const t=this._apiClient;if(!t)throw new Error("Cannot refresh the token before calling init.");t.callRefreshApi(e).then((e=>{switch(e.status){case"success":this.validateAndSetIdentity(e.identity,r.IdentityStatus.REFRESHED,"Identity refreshed"),this.setRefreshTimer();break;case"optout":this.validateAndSetIdentity(null,r.IdentityStatus.OPTOUT,"User opted out");break;case"expired_token":this.validateAndSetIdentity(null,r.IdentityStatus.REFRESH_EXPIRED,"Refresh token expired")}}),(t=>{console.warn("Encountered an error refreshing the UID2 token",t),this.validateAndSetIdentity(e),f(e.refresh_expires,Date.now())||this.setRefreshTimer()})).then((()=>{this._callbackManager.runCallbacks(d.EventType.IdentityUpdated,{})}),(e=>console.warn("UID2 callbacks on identity event failed.",e)))}callCstgAndSetIdentity(e,t){return n(this,void 0,void 0,(function*(){const i=yield this._apiClient.callCstgApi(e,t);this.setIdentity(i.identity)}))}throwIfInitNotComplete(e){if(!this._initComplete)throw new Error(e)}}function g(){var e;const t=(null===(e=null===window||void 0===window?void 0:window.__uid2)||void 0===e?void 0:e.callbacks)||[];window.__uid2=new v(t),_&&_()}t.UID2=v,v.IdentityStatus=r.IdentityStatus,v.EventType=d.EventType,t.__uid2InternalHandleScriptLoad=g,g(),t.sdkWindow=globalThis.window},348:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.UID2StorageManager=void 0;const n=i(834),s=i(987);t.UID2StorageManager=class{constructor(e){this._opts=e,this._cookieManager=new n.UID2CookieManager(Object.assign({},e)),this._localStorageManager=new s.UID2LocalStorageManager}loadIdentityWithFallback(){const e=this._localStorageManager.loadIdentityFromLocalStorage(),t=this._cookieManager.loadIdentityFromCookie();return t&&(!e||t.identity_expires>e.identity_expires)?t:e}loadIdentity(){return this._opts.useCookie?this._cookieManager.loadIdentityFromCookie():this._localStorageManager.loadIdentityFromLocalStorage()}setValue(e){this._opts.useCookie?this._cookieManager.setCookie(e):(this._localStorageManager.setValue(e),!1===this._opts.useCookie&&this._localStorageManager.loadIdentityFromLocalStorage()&&this._cookieManager.removeCookie())}removeValues(){this._cookieManager.removeCookie(),this._localStorageManager.removeValue()}}},147:e=>{e.exports=JSON.parse('{"name":"@uid2/uid2-sdk","version":"3.2.0","description":"UID2 Client SDK","main":"lib/uid2Sdk.js","types":"lib/uid2Sdk.d.ts","files":["/lib"],"author":"The Trade Desk","license":"Apache 2.0","scripts":{"lint":"eslint -c .eslintrc.js . ../static/js/uid2-sdk-2.0.0.js ../static/js/uid2-sdk-1.0.0.js","test":"jest","build":"webpack","build-with-sourcemaps":"webpack --mode=production --env prodSourceMaps=true","build-package":"tsc","watch":"webpack watch --mode=development","webpack-dev-server":"webpack-dev-server --config webpack-dev-server.config.js --hot --port 9091","uid2-examples":"webpack --mode=development --env outputToExamples=true","build:esp":"webpack --env espOnly=true"},"jest":{"preset":"ts-jest","testEnvironment":"jsdom","setupFilesAfterEnv":["./setupJest.js"],"testPathIgnorePatterns":["/node_modules/","/dist/"]},"devDependencies":{"@jest/globals":"^29.2.2","@types/jest":"^29.2.0","@types/node":"^18.11.3","@typescript-eslint/eslint-plugin":"^5.40.1","@typescript-eslint/parser":"^5.40.1","eslint":"^8.25.0","eslint-config-airbnb-typescript":"^17.0.0","eslint-plugin-import":"^2.26.0","eslint-plugin-promise":"^6.1.1","eslint-plugin-simple-import-sort":"^8.0.0","eslint-plugin-testing-library":"^5.9.0","jest":"^29.2.1","jest-environment-jsdom":"^29.2.1","jsdom":"^20.0.1","ts-jest":"^29.0.3","ts-loader":"^9.4.1","typescript":"^4.8.4","webpack":"^5.74.0","webpack-cli":"^4.10.0","webpack-dev-server":"^4.15.1"}}')}},t={};!function i(n){var s=t[n];if(void 0!==s)return s.exports;var r=t[n]={exports:{}};return e[n].call(r.exports,r,r.exports,i),r.exports}(890)})();